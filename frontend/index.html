<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>≈Ωeny ≈Ωen√°m - V√Ωmƒõna slu≈æeb</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 100vh;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 24px 40px;
            border-bottom: 3px solid #34495e;
            position: relative;
        }
        
        .header h1 {
            font-size: 1.75em;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }
        
        .header p {
            font-size: 0.95em;
            opacity: 0.85;
            font-weight: 400;
        }
        
        .logout-btn {
            position: absolute;
            top: 24px;
            right: 40px;
            padding: 8px 20px;
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: 600;
        }
        
        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 16px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.2s;
            position: relative;
            border-bottom: 2px solid transparent;
        }
        
        .tab:hover {
            background: #dfe4e8;
            color: #2c3e50;
        }
        
        .tab.active {
            background: white;
            color: #2c3e50;
            border-bottom-color: #3498db;
            font-weight: 600;
        }
        
        .content {
            padding: 40px;
            min-height: 400px;
            background: #fafbfc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #f5576c;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checkbox-item:hover {
            background: #e9ecef;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        /* Avatar Styles */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .avatar-option {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .avatar-option:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }
        
        .avatar-option.selected {
            border-color: #f5576c;
            background: #fff5f7;
        }
        
        .avatar-icon {
            font-size: 4em;
            margin-bottom: 5px;
        }
        
        .avatar-label {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .avatar-display {
            display: inline-block;
            font-size: 3em;
            margin-right: 15px;
            vertical-align: middle;
        }
        
        .btn {
            padding: 10px 24px;
            border: none;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
            margin-left: 10px;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-small {
            padding: 6px 16px;
            font-size: 0.85em;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-link {
            background: none;
            color: #667eea;
            padding: 5px;
            text-decoration: underline;
        }
        
        .profile-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .profile-card h3 {
            color: #f5576c;
            margin-bottom: 10px;
        }
        
        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }
        
        .info-item strong {
            color: #495057;
            display: block;
            margin-bottom: 5px;
        }
        
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .user-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .user-card h4 {
            color: #f5576c;
            margin-bottom: 10px;
        }
        
        .user-card .location {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .services-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        
        .tag {
            padding: 6px 12px;
            background: white;
            border-radius: 20px;
            font-size: 0.85em;
            color: #495057;
        }
        
        .tag.offer {
            background: #d4edda;
            color: #155724;
        }
        
        .tag.need {
            background: #cce5ff;
            color: #004085;
        }
        
        .message-box {
            margin-top: 15px;
            display: none;
        }
        
        .message-box.active {
            display: block;
        }
        
        .message-box textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
            font-family: inherit;
        }
        
        /* Messages Tab Styles */
        .messages-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .conversation-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .conversation-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .conversation-item:hover {
            background: #e9ecef;
            border-left-color: #f5576c;
        }
        
        .conversation-item.unread {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .conversation-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .conversation-avatar {
            font-size: 2.5em;
            margin-right: 15px;
        }
        
        .conversation-info h4 {
            color: #f5576c;
            margin-bottom: 5px;
        }
        
        .conversation-info .email {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .conversation-preview {
            color: #495057;
            margin-top: 10px;
            font-size: 0.95em;
        }
        
        .conversation-time {
            color: #6c757d;
            font-size: 0.85em;
            text-align: right;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .hidden {
            display: none !important;
        }
        
        .edit-mode {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .password-match {
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .password-match.valid {
            color: #28a745;
        }
        
        .password-match.invalid {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="logout-btn hidden" id="logout-btn" onclick="logout()">üö™ Odhl√°sit se</button>
            <h1>üíú ≈Ωeny ≈Ωen√°m</h1>
            <p>Komunita pro v√Ωmƒõnu slu≈æeb a vz√°jemnou podporu</p>
        </div>
        
        <div class="tabs" id="tabs">
            <button class="tab active" data-tab="login">üîê P≈ôihl√°≈°en√≠</button>
            <button class="tab hidden" data-tab="profile">üë§ M≈Øj profil</button>
            <button class="tab hidden" data-tab="search">üîç Hledat</button>
            <button class="tab hidden" data-tab="messages" style="position: relative;">
                üí¨ Zpr√°vy
                <span class="notification-badge hidden" id="message-badge">0</span>
            </button>
        </div>
        
        <div class="content">
            <!-- LOGIN/REGISTER TAB -->
            <div id="login-tab" class="tab-content active">
                <div id="login-form">
                    <h2 style="margin-bottom: 25px; color: #495057;">P≈ôihl√°≈°en√≠</h2>
                    
                    <div id="login-error" class="alert alert-danger hidden"></div>
                    
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="login-email" placeholder="tvuj@email.cz">
                    </div>
                    
                    <div class="form-group">
                        <label>Heslo *</label>
                        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="handleLogin()" id="login-btn">
                        P≈ôihl√°sit se
                    </button>
                    
                    <p style="margin-top: 20px; color: #6c757d;">
                        Je≈°tƒõ nem√°≈° √∫ƒçet? 
                        <button class="btn-link" onclick="showRegisterForm()">Zaregistruj se</button>
                    </p>
                    
                    <p style="margin-top: 10px; color: #6c757d;">
                        Zapomnƒõla jsi heslo? 
                        <button class="btn-link" onclick="showPasswordResetForm()">Resetovat heslo</button>
                    </p>
                </div>
                
                <div id="password-reset-form" class="hidden">
                    <h2 style="margin-bottom: 25px; color: #495057;">Resetovat heslo</h2>
                    
                    <div id="reset-error" class="alert alert-danger hidden"></div>
                    <div id="reset-success" class="alert alert-success hidden"></div>
                    
                    <div id="reset-step-1">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="reset-email" placeholder="tvuj@email.cz">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="requestPasswordReset()" id="reset-request-btn">
                            Poslat reset k√≥d
                        </button>
                    </div>
                    
                    <div id="reset-step-2" class="hidden">
                        <div class="alert alert-info">
                            <strong>Reset k√≥d:</strong> <span id="display-reset-code" style="font-size: 1.5em; font-weight: bold;"></span>
                            <p style="margin-top: 10px;">Zkop√≠ruj tento k√≥d a zadej ho n√≠≈æe spolu s nov√Ωm heslem.</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Reset k√≥d *</label>
                            <input type="text" id="reset-code" placeholder="6-m√≠stn√Ω k√≥d" maxlength="6">
                        </div>
                        
                        <div class="form-group">
                            <label>Nov√© heslo *</label>
                            <input type="password" id="reset-new-password" placeholder="Alespo≈à 6 znak≈Ø">
                        </div>
                        
                        <div class="form-group">
                            <label>Potvrƒè nov√© heslo *</label>
                            <input type="password" id="reset-confirm-password" placeholder="Zadej heslo znovu">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="confirmPasswordReset()" id="reset-confirm-btn">
                            Zmƒõnit heslo
                        </button>
                    </div>
                    
                    <p style="margin-top: 20px; color: #6c757d;">
                        <button class="btn-link" onclick="showLoginForm()">Zpƒõt na p≈ôihl√°≈°en√≠</button>
                    </p>
                </div>
                
                <div id="register-form" class="hidden">
                    <h2 style="margin-bottom: 25px; color: #495057;">Vytvo≈ô si profil</h2>
                    
                    <div id="register-error" class="alert alert-danger hidden"></div>
                    
                    <div class="form-group">
                        <label>Jm√©no / P≈ôezd√≠vka *</label>
                        <input type="text" id="register-name" placeholder="Jak se ti m≈Ø≈æeme ≈ô√≠kat?">
                    </div>
                    
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="register-email" placeholder="tvuj@email.cz">
                    </div>
                    
                    <div class="form-group">
                        <label>Heslo * (minim√°lnƒõ 6 znak≈Ø)</label>
                        <input type="password" id="register-password" placeholder="Alespo≈à 6 znak≈Ø" oninput="checkPasswordMatch()">
                    </div>
                    
                    <div class="form-group">
                        <label>Potvrƒè heslo *</label>
                        <input type="password" id="register-password-confirm" placeholder="Zadej heslo znovu" oninput="checkPasswordMatch()">
                        <div id="password-match-msg" class="password-match"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Mƒõsto / Lokalita *</label>
                        <select id="register-city">
                            <option value="">-- Vyber mƒõsto --</option>
                            <optgroup label="Hlavn√≠ mƒõsto">
                                <option value="Praha">Praha</option>
                            </optgroup>
                            <optgroup label="Krajsk√° mƒõsta">
                                <option value="Brno">Brno</option>
                                <option value="Ostrava">Ostrava</option>
                                <option value="Plze≈à">Plze≈à</option>
                                <option value="Liberec">Liberec</option>
                                <option value="Olomouc">Olomouc</option>
                                <option value="ƒåesk√© Budƒõjovice">ƒåesk√© Budƒõjovice</option>
                                <option value="Hradec Kr√°lov√©">Hradec Kr√°lov√©</option>
                                <option value="√öst√≠ nad Labem">√öst√≠ nad Labem</option>
                                <option value="Pardubice">Pardubice</option>
                                <option value="Zl√≠n">Zl√≠n</option>
                                <option value="Hav√≠≈ôov">Hav√≠≈ôov</option>
                                <option value="Kladno">Kladno</option>
                                <option value="Most">Most</option>
                                <option value="Opava">Opava</option>
                                <option value="Karvin√°">Karvin√°</option>
                                <option value="Fr√Ωdek-M√≠stek">Fr√Ωdek-M√≠stek</option>
                            </optgroup>
                            <optgroup label="Dal≈°√≠ vƒõt≈°√≠ mƒõsta">
                                <option value="Jihlava">Jihlava</option>
                                <option value="Teplice">Teplice</option>
                                <option value="Karlovy Vary">Karlovy Vary</option>
                                <option value="Dƒõƒç√≠n">Dƒõƒç√≠n</option>
                                <option value="Chomutov">Chomutov</option>
                                <option value="Jablonec nad Nisou">Jablonec nad Nisou</option>
                                <option value="Mlad√° Boleslav">Mlad√° Boleslav</option>
                                <option value="Prostƒõjov">Prostƒõjov</option>
                                <option value="P≈ôerov">P≈ôerov</option>
                                <option value="T≈ôinec">T≈ôinec</option>
                                <option value="T≈ôeb√≠ƒç">T≈ôeb√≠ƒç</option>
                                <option value="T√°bor">T√°bor</option>
                                <option value="Znojmo">Znojmo</option>
                                <option value="P≈ô√≠bram">P≈ô√≠bram</option>
                                <option value="Cheb">Cheb</option>
                                <option value="Orlov√°">Orlov√°</option>
                                <option value="Kromƒõ≈ô√≠≈æ">Kromƒõ≈ô√≠≈æ</option>
                                <option value="Hodon√≠n">Hodon√≠n</option>
                                <option value="V√≠tkovice">V√≠tkovice</option>
                                <option value="≈†umperk">≈†umperk</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Vyber si avatar *</label>
                        <div class="avatar-grid" id="avatar-grid">
                            <div class="avatar-option selected" data-avatar="avatar1" onclick="selectAvatar('avatar1')">
                                <div class="avatar-icon">üë©</div>
                                <div class="avatar-label">Z√°kladn√≠</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar2" onclick="selectAvatar('avatar2')">
                                <div class="avatar-icon">üë©‚Äçü¶∞</div>
                                <div class="avatar-label">Zrzka</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar3" onclick="selectAvatar('avatar3')">
                                <div class="avatar-icon">üë±‚Äç‚ôÄÔ∏è</div>
                                <div class="avatar-label">Blond√Ωnka</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar4" onclick="selectAvatar('avatar4')">
                                <div class="avatar-icon">üë©‚Äçü¶±</div>
                                <div class="avatar-label">Kudrnat√© vlasy</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar5" onclick="selectAvatar('avatar5')">
                                <div class="avatar-icon">üë©‚Äçü¶≥</div>
                                <div class="avatar-label">≈†ediv√© vlasy</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar6" onclick="selectAvatar('avatar6')">
                                <div class="avatar-icon">üßï</div>
                                <div class="avatar-label">S ≈°√°tkem</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar7" onclick="selectAvatar('avatar7')">
                                <div class="avatar-icon">üëì</div>
                                <div class="avatar-label">S br√Ωlemi</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar8" onclick="selectAvatar('avatar8')">
                                <div class="avatar-icon">üéÄ</div>
                                <div class="avatar-label">S ma≈°l√≠</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar9" onclick="selectAvatar('avatar9')">
                                <div class="avatar-icon">üíº</div>
                                <div class="avatar-label">Business</div>
                            </div>
                            <div class="avatar-option" data-avatar="avatar10" onclick="selectAvatar('avatar10')">
                                <div class="avatar-icon">üå∏</div>
                                <div class="avatar-label">S kvƒõtinou</div>
                            </div>
                        </div>
                        <input type="hidden" id="selected-avatar" value="avatar1">
                    </div>
                    
                    <div class="form-group">
                        <label>O mnƒõ (nepovinn√©)</label>
                        <textarea id="register-bio" rows="3" placeholder="Kr√°tk√Ω popis o tobƒõ, tv√Ωch z√°jmech nebo zku≈°enostech..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>‚úÖ Slu≈æby, kter√© nab√≠z√≠m</label>
                        <div class="checkbox-group" id="register-services-offer"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>üîç Slu≈æby, kter√© hled√°m</label>
                        <div class="checkbox-group" id="register-services-need"></div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="handleRegister()" id="register-btn">
                        Vytvo≈ôit profil
                    </button>
                    
                    <p style="margin-top: 20px; color: #6c757d;">
                        U≈æ m√°≈° √∫ƒçet? 
                        <button class="btn-link" onclick="showLoginForm()">P≈ôihlas se</button>
                    </p>
                </div>
            </div>
            
            <!-- PROFILE TAB -->
            <div id="profile-tab" class="tab-content">
                <div id="profile-content"></div>
            </div>
            
            <!-- SEARCH TAB -->
            <div id="search-tab" class="tab-content">
                <div id="search-content"></div>
            </div>
            
            <!-- MESSAGES TAB -->
            <div id="messages-tab" class="tab-content">
                <div class="messages-container">
                    <h2 style="margin-bottom: 20px; color: #495057;">üí¨ Moje zpr√°vy</h2>
                    <div id="messages-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://zenyzenam.onrender.com/api';
        
        // Avatar map
        const AVATAR_ICONS = {
            'avatar1': 'üë©',
            'avatar2': 'üë©‚Äçü¶∞',
            'avatar3': 'üë±‚Äç‚ôÄÔ∏è',
            'avatar4': 'üë©‚Äçü¶±',
            'avatar5': 'üë©‚Äçü¶≥',
            'avatar6': 'üßï',
            'avatar7': 'üëì',
            'avatar8': 'üéÄ',
            'avatar9': 'üíº',
            'avatar10': 'üå∏'
        };
        
        let services = [];
        let currentUser = null;
        let token = null;
        let editMode = false;
        let selectedAvatar = 'avatar1';
        let unreadMessages = 0;
        
        // API Helper
        async function apiCall(endpoint, options = {}) {
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                },
                ...options
            };
            
            const response = await fetch(`${API_URL}${endpoint}`, config);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Nƒõco se pokazilo');
            }
            
            return data;
        }
        
        // Init
        async function init() {
            try {
                services = await apiCall('/services');
                const savedToken = localStorage.getItem('token');
                if (savedToken) {
                    token = savedToken;
                    await loadUserProfile();
                }
            } catch (error) {
                console.error('Init error:', error);
            }
            
            renderServiceCheckboxes();
        }
        
        async function loadUserProfile() {
            try {
                currentUser = await apiCall('/profile');
                showLoggedInState();
                renderProfile();
                loadMessages();
            } catch (error) {
                console.error('Failed to load profile:', error);
                localStorage.removeItem('token');
                token = null;
            }
        }
        
        // Avatar selection
        function selectAvatar(avatar) {
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
            document.getElementById('selected-avatar').value = avatar;
            selectedAvatar = avatar;
        }
        
        function getAvatarIcon(avatar) {
            return AVATAR_ICONS[avatar] || 'üë©';
        }
        
        // Password match check
        function checkPasswordMatch() {
            const pwd = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-password-confirm').value;
            const msg = document.getElementById('password-match-msg');
            
            if (!confirm) {
                msg.textContent = '';
                return;
            }
            
            if (pwd === confirm) {
                msg.textContent = '‚úì Hesla se shoduj√≠';
                msg.className = 'password-match valid';
            } else {
                msg.textContent = '‚úó Hesla se neshoduj√≠';
                msg.className = 'password-match invalid';
            }
        }
        
        // Password Reset Functions
        function showPasswordResetForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('password-reset-form').classList.remove('hidden');
            document.getElementById('reset-step-1').classList.remove('hidden');
            document.getElementById('reset-step-2').classList.add('hidden');
            document.getElementById('reset-error').classList.add('hidden');
            document.getElementById('reset-success').classList.add('hidden');
        }
        
        async function requestPasswordReset() {
            const email = document.getElementById('reset-email').value;
            const errorDiv = document.getElementById('reset-error');
            const successDiv = document.getElementById('reset-success');
            const btn = document.getElementById('reset-request-btn');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (!email) {
                errorDiv.textContent = 'Pros√≠m zadej email';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = 'Generuji k√≥d...';
                
                const response = await apiCall('/password-reset/request', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });
                
                document.getElementById('display-reset-code').textContent = response.resetCode;
                document.getElementById('reset-step-1').classList.add('hidden');
                document.getElementById('reset-step-2').classList.remove('hidden');
                
                successDiv.textContent = 'Reset k√≥d byl vygenerov√°n!';
                successDiv.classList.remove('hidden');
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Poslat reset k√≥d';
            }
        }
        
        async function confirmPasswordReset() {
            const email = document.getElementById('reset-email').value;
            const resetCode = document.getElementById('reset-code').value;
            const newPassword = document.getElementById('reset-new-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;
            const errorDiv = document.getElementById('reset-error');
            const btn = document.getElementById('reset-confirm-btn');
            
            errorDiv.classList.add('hidden');
            
            if (!resetCode || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'Pros√≠m vypl≈à v≈°echna pole';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Hesla se neshoduj√≠';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword.length < 6) {
                errorDiv.textContent = 'Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = 'Mƒõn√≠m heslo...';
                
                await apiCall('/password-reset/confirm', {
                    method: 'POST',
                    body: JSON.stringify({ email, resetCode, newPassword })
                });
                
                alert('‚úÖ Heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno! Nyn√≠ se m≈Ø≈æe≈° p≈ôihl√°sit.');
                
                // Reset form
                document.getElementById('reset-email').value = '';
                document.getElementById('reset-code').value = '';
                document.getElementById('reset-new-password').value = '';
                document.getElementById('reset-confirm-password').value = '';
                
                showLoginForm();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Zmƒõnit heslo';
            }
        }
        
        // Forms
        function showRegisterForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('password-reset-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            renderServiceCheckboxes();
        }
        
        function showLoginForm() {
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('password-reset-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }
        
        function showLoggedInState() {
            document.querySelectorAll('[data-tab="profile"], [data-tab="search"], [data-tab="messages"]').forEach(tab => {
                tab.classList.remove('hidden');
            });
            document.querySelector('[data-tab="login"]').classList.add('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
        }
        
        // Login
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');
            
            errorDiv.classList.add('hidden');
            
            if (!email || !password) {
                errorDiv.textContent = 'Pros√≠m vypl≈à email a heslo';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = 'P≈ôihla≈°uji...';
                
                const response = await apiCall('/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                token = response.token;
                currentUser = response.user;
                localStorage.setItem('token', token);
                
                showLoggedInState();
                renderProfile();
                switchTab('profile');
                
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                
                loadMessages();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'P≈ôihl√°sit se';
            }
        }
        
        // Register
        async function handleRegister() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const city = document.getElementById('register-city').value;
            const bio = document.getElementById('register-bio').value;
            const avatar = document.getElementById('selected-avatar').value;
            const errorDiv = document.getElementById('register-error');
            const btn = document.getElementById('register-btn');
            
            errorDiv.classList.add('hidden');
            
            if (!name || !email || !password || !city) {
                errorDiv.textContent = 'Pros√≠m vypl≈à v≈°echna povinn√° pole';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password !== passwordConfirm) {
                errorDiv.textContent = 'Hesla se neshoduj√≠';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const servicesOffered = Array.from(document.querySelectorAll('input[name="register-offer"]:checked'))
                .map(cb => parseInt(cb.value));
            const servicesNeeded = Array.from(document.querySelectorAll('input[name="register-need"]:checked'))
                .map(cb => parseInt(cb.value));
            
            try {
                btn.disabled = true;
                btn.textContent = 'Registruji...';
                
                const response = await apiCall('/register', {
                    method: 'POST',
                    body: JSON.stringify({
                        name, email, password, city, bio, avatar,
                        servicesOffered, servicesNeeded
                    })
                });
                
                token = response.token;
                localStorage.setItem('token', token);
                
                await loadUserProfile();
                showLoggedInState();
                switchTab('profile');
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Vytvo≈ôit profil';
            }
        }
        
        // Logout
        function logout() {
            if (confirm('Chce≈° se odhl√°sit?')) {
                token = null;
                currentUser = null;
                localStorage.removeItem('token');
                
                document.querySelectorAll('[data-tab="profile"], [data-tab="search"], [data-tab="messages"]').forEach(tab => {
                    tab.classList.add('hidden');
                });
                document.querySelector('[data-tab="login"]').classList.remove('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                
                showLoginForm();
                switchTab('login');
            }
        }
        
        // Services
        function renderServiceCheckboxes() {
            const offerContainer = document.getElementById('register-services-offer');
            const needContainer = document.getElementById('register-services-need');
            
            if (offerContainer) {
                offerContainer.innerHTML = '';
                services.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="reg-offer-${service.id}" name="register-offer" value="${service.id}">
                        <label for="reg-offer-${service.id}">${service.name}</label>
                    `;
                    offerContainer.appendChild(div);
                });
            }
            
            if (needContainer) {
                needContainer.innerHTML = '';
                services.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="reg-need-${service.id}" name="register-need" value="${service.id}">
                        <label for="reg-need-${service.id}">${service.name}</label>
                    `;
                    needContainer.appendChild(div);
                });
            }
        }
        
        // Profile
        function renderProfile() {
            if (!currentUser) return;
            
            const container = document.getElementById('profile-content');
            const avatarIcon = getAvatarIcon(currentUser.avatar);
            
            let html = `
                <div class="profile-card">
                    <h3>
                        <span class="avatar-display">${avatarIcon}</span>
                        V√≠tej, ${currentUser.name}! üëã
                    </h3>
                    <div class="profile-info">
                        <div class="info-item">
                            <strong>üìç Lokalita</strong>
                            ${currentUser.city}
                        </div>
                        <div class="info-item">
                            <strong>üìß Email</strong>
                            ${currentUser.email}
                        </div>
                    </div>
            `;
            
            if (currentUser.bio) {
                html += `
                    <div class="info-item" style="margin-top: 15px;">
                        <strong>üí≠ O mnƒõ</strong>
                        ${currentUser.bio}
                    </div>
                `;
            }
            
            html += `</div>`;
            
            if (editMode) {
                html += `
                    <div class="edit-mode">
                        <h3 style="margin-bottom: 15px;">‚úèÔ∏è √öprava profilu</h3>
                        
                        <div class="form-group">
                            <label>Mƒõsto</label>
                            <select id="edit-city">
                                <optgroup label="Hlavn√≠ mƒõsto">
                                    <option value="Praha">Praha</option>
                                </optgroup>
                                <optgroup label="Krajsk√° mƒõsta">
                                    <option value="Brno">Brno</option>
                                    <option value="Ostrava">Ostrava</option>
                                    <option value="Plze≈à">Plze≈à</option>
                                    <option value="Liberec">Liberec</option>
                                    <option value="Olomouc">Olomouc</option>
                                    <option value="ƒåesk√© Budƒõjovice">ƒåesk√© Budƒõjovice</option>
                                    <option value="Hradec Kr√°lov√©">Hradec Kr√°lov√©</option>
                                    <option value="√öst√≠ nad Labem">√öst√≠ nad Labem</option>
                                    <option value="Pardubice">Pardubice</option>
                                    <option value="Zl√≠n">Zl√≠n</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Avatar</label>
                            <div class="avatar-grid" id="edit-avatar-grid"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>‚úÖ Slu≈æby, kter√© nab√≠z√≠m</label>
                            <div class="checkbox-group" id="edit-services-offer"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>üîç Slu≈æby, kter√© hled√°m</label>
                            <div class="checkbox-group" id="edit-services-need"></div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveProfileEdit()">üíæ Ulo≈æit zmƒõny</button>
                        <button class="btn btn-secondary" onclick="cancelProfileEdit()">‚ùå Zru≈°it</button>
                    </div>
                `;
            } else {
                html += `
                    <div class="profile-card">
                        <h3>‚úÖ Nab√≠z√≠m tyto slu≈æby:</h3>
                        <div class="services-tags">
                `;
                
                if (currentUser.servicesOffered && currentUser.servicesOffered.length > 0) {
                    currentUser.servicesOffered.forEach(s => {
                        html += `<span class="tag offer">${s.name}</span>`;
                    });
                } else {
                    html += `<p style="color: #6c757d;">Zat√≠m ≈æ√°dn√© slu≈æby nenab√≠z√≠≈°</p>`;
                }
                
                html += `
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <h3>üîç Hled√°m tyto slu≈æby:</h3>
                        <div class="services-tags">
                `;
                
                if (currentUser.servicesNeeded && currentUser.servicesNeeded.length > 0) {
                    currentUser.servicesNeeded.forEach(s => {
                        html += `<span class="tag need">${s.name}</span>`;
                    });
                } else {
                    html += `<p style="color: #6c757d;">Zat√≠m nehled√°≈° ≈æ√°dn√© slu≈æby</p>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            if (!editMode) {
                html += `
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="startProfileEdit()">‚úèÔ∏è Upravit profil</button>
                        <button class="btn btn-danger" onclick="deleteProfile()">üóëÔ∏è Smazat profil</button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            if (editMode) {
                document.getElementById('edit-city').value = currentUser.city;
                renderEditAvatars();
                renderEditCheckboxes();
            }
        }
        
        function renderEditAvatars() {
            const container = document.getElementById('edit-avatar-grid');
            container.innerHTML = '';
            
            Object.keys(AVATAR_ICONS).forEach(avatarKey => {
                const div = document.createElement('div');
                div.className = 'avatar-option' + (currentUser.avatar === avatarKey ? ' selected' : '');
                div.setAttribute('data-avatar', avatarKey);
                div.onclick = () => selectEditAvatar(avatarKey);
                div.innerHTML = `
                    <div class="avatar-icon">${AVATAR_ICONS[avatarKey]}</div>
                `;
                container.appendChild(div);
            });
        }
        
        function selectEditAvatar(avatar) {
            document.querySelectorAll('#edit-avatar-grid .avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#edit-avatar-grid [data-avatar="${avatar}"]`).classList.add('selected');
            selectedAvatar = avatar;
        }
        
        function renderEditCheckboxes() {
            const offerContainer = document.getElementById('edit-services-offer');
            const needContainer = document.getElementById('edit-services-need');
            
            if (offerContainer) {
                offerContainer.innerHTML = '';
                services.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    const checked = currentUser.servicesOffered.some(s => s.id === service.id) ? 'checked' : '';
                    div.innerHTML = `
                        <input type="checkbox" id="edit-offer-${service.id}" name="edit-offer" value="${service.id}" ${checked}>
                        <label for="edit-offer-${service.id}">${service.name}</label>
                    `;
                    offerContainer.appendChild(div);
                });
            }
            
            if (needContainer) {
                needContainer.innerHTML = '';
                services.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    const checked = currentUser.servicesNeeded.some(s => s.id === service.id) ? 'checked' : '';
                    div.innerHTML = `
                        <input type="checkbox" id="edit-need-${service.id}" name="edit-need" value="${service.id}" ${checked}>
                        <label for="edit-need-${service.id}">${service.name}</label>
                    `;
                    needContainer.appendChild(div);
                });
            }
        }
        
        function startProfileEdit() {
            editMode = true;
            selectedAvatar = currentUser.avatar;
            renderProfile();
        }
        
        function cancelProfileEdit() {
            editMode = false;
            renderProfile();
        }
        
        async function saveProfileEdit() {
            const city = document.getElementById('edit-city').value;
            const servicesOffered = Array.from(document.querySelectorAll('input[name="edit-offer"]:checked'))
                .map(cb => parseInt(cb.value));
            const servicesNeeded = Array.from(document.querySelectorAll('input[name="edit-need"]:checked'))
                .map(cb => parseInt(cb.value));
            
            try {
                await apiCall('/profile/city', {
                    method: 'PUT',
                    body: JSON.stringify({ city })
                });
                
                await apiCall('/profile/avatar', {
                    method: 'PUT',
                    body: JSON.stringify({ avatar: selectedAvatar })
                });
                
                await apiCall('/profile/services', {
                    method: 'PUT',
                    body: JSON.stringify({ servicesOffered, servicesNeeded })
                });
                
                await loadUserProfile();
                editMode = false;
                renderProfile();
                
                alert('‚úÖ Profil byl √∫spƒõ≈°nƒõ aktualizov√°n!');
            } catch (error) {
                alert('Chyba: ' + error.message);
            }
        }
        
        async function deleteProfile() {
            if (confirm('‚ö†Ô∏è Opravdu chce≈° smazat sv≈Øj profil? Tato akce je nevratn√°!')) {
                try {
                    await apiCall('/profile', { method: 'DELETE' });
                    logout();
                    alert('‚úÖ Profil byl smaz√°n.');
                } catch (error) {
                    alert('Chyba: ' + error.message);
                }
            }
        }
        
        // Search
        async function renderSearch() {
            const container = document.getElementById('search-content');
            
            if (!currentUser) {
                container.innerHTML = '<p>Nejd≈ô√≠ve se p≈ôihla≈°</p>';
                return;
            }
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Hled√°m ≈æeny ve tv√©m mƒõstƒõ...</div>';
            
            try {
                const matches = await apiCall('/search');
                
                let html = `<h2 style="margin-bottom: 20px; color: #495057;">≈Ωeny ve tv√©m mƒõstƒõ (${currentUser.city})</h2>`;
                
                if (matches.length > 0) {
                    html += '<div class="users-grid">';
                    matches.forEach(user => {
                        const avatarIcon = getAvatarIcon(user.avatar);
                        html += `
                            <div class="user-card">
                                <h4><span class="avatar-display" style="font-size: 2em;">${avatarIcon}</span> ${user.name}</h4>
                                <div class="location">üìç ${user.city}</div>
                                <div class="location">üìß ${user.email}</div>
                        `;
                        
                        if (user.bio) {
                            html += `<p style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">${user.bio}</p>`;
                        }
                        
                        html += `
                                <strong style="font-size: 0.9em; color: #495057;">Nab√≠z√≠ slu≈æby, kter√© hled√°≈°:</strong>
                                <div class="services-tags">
                        `;
                        
                        user.servicesOffered.forEach(s => {
                            html += `<span class="tag offer">${s.name}</span>`;
                        });
                        
                        html += `
                                </div>
                                <button class="btn btn-primary btn-small" style="width: 100%; margin-top: 15px;" onclick="showMessageBox(${user.id})">
                                    üí¨ Napsat zpr√°vu
                                </button>
                                <div class="message-box" id="msg-${user.id}">
                                    <textarea id="msg-text-${user.id}" rows="3" placeholder="Napi≈° ${user.name} zpr√°vu..."></textarea>
                                    <button class="btn btn-primary btn-small" onclick="sendMessage(${user.id}, '${user.name}', '${user.email}')">Odeslat</button>
                                    <button class="btn btn-secondary btn-small" onclick="hideMessageBox(${user.id})">Zru≈°it</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += `
                        <div class="alert alert-info">
                            <strong>üîç Zat√≠m nejsou k dispozici ≈æ√°dn√© shody</strong>
                            <p style="margin-top: 10px;">V tv√©m mƒõstƒõ zat√≠m nejsou ≈æeny, kter√© nab√≠zej√≠ slu≈æby, o kter√© m√°≈° z√°jem.</p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger"><strong>Chyba p≈ôi vyhled√°v√°n√≠</strong><p>${error.message}</p></div>`;
            }
        }
        
        function showMessageBox(userId) {
            document.getElementById('msg-' + userId).classList.add('active');
        }
        
        function hideMessageBox(userId) {
            document.getElementById('msg-' + userId).classList.remove('active');
        }
        
        async function sendMessage(userId, userName, userEmail) {
            const message = document.getElementById('msg-text-' + userId).value;
            
            if (!message.trim()) {
                alert('Napi≈° nƒõjakou zpr√°vu');
                return;
            }
            
            try {
                await apiCall('/messages', {
                    method: 'POST',
                    body: JSON.stringify({ toUserId: userId, message })
                });
                
                alert(`‚úÖ Zpr√°va odesl√°na pro ${userName}!\n\nüìß Kontakt: ${userEmail}\n\n‚ö†Ô∏è BEZPEƒåNOSTN√ç POKYNY:\n\n‚úì Setkejte se v≈ædy na ve≈ôejn√©m m√≠stƒõ\n‚úì ≈òeknƒõte nƒõkomu bl√≠zk√©mu, kde budete\n‚úì Mƒõjte nabit√Ω telefon\n‚úì D≈Øvƒõ≈ôujte sv√©mu instinktu`);
                
                document.getElementById('msg-text-' + userId).value = '';
                hideMessageBox(userId);
                
                loadMessages();
            } catch (error) {
                alert('Chyba: ' + error.message);
            }
        }
        
        // Messages
        async function loadMessages() {
            if (!currentUser) return;
            
            try {
                const messages = await apiCall('/messages');
                
                const grouped = {};
                messages.forEach(msg => {
                    const otherUserId = msg.from_user_id === currentUser.id ? msg.to_user_id : msg.from_user_id;
                    if (!grouped[otherUserId]) {
                        grouped[otherUserId] = [];
                    }
                    grouped[otherUserId].push(msg);
                });
                
                const conversations = Object.keys(grouped).map(userId => {
                    const msgs = grouped[userId];
                    const lastMsg = msgs[0];
                    const otherUser = lastMsg.from_user_id === currentUser.id ? 
                        { id: lastMsg.to_user_id, name: lastMsg.to_name, email: lastMsg.to_email, avatar: lastMsg.to_avatar } :
                        { id: lastMsg.from_user_id, name: lastMsg.from_name, email: lastMsg.from_email, avatar: lastMsg.from_avatar };
                    
                    return {
                        user: otherUser,
                        lastMessage: lastMsg,
                        messages: msgs
                    };
                });
                
                renderMessages(conversations);
                
                unreadMessages = conversations.length;
                updateMessageBadge();
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }
        
        function renderMessages(conversations) {
            const container = document.getElementById('messages-content');
            
            if (conversations.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>üì≠ Zat√≠m ≈æ√°dn√© zpr√°vy</strong>
                        <p style="margin-top: 10px;">Kdy≈æ ti nƒõkdo nap√≠≈°e, uvid√≠≈° to tady!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="conversation-list">';
            
            conversations.forEach(conv => {
                const avatarIcon = getAvatarIcon(conv.user.avatar);
                const time = new Date(conv.lastMessage.created_at).toLocaleString('cs-CZ');
                const preview = conv.lastMessage.message.substring(0, 100) + (conv.lastMessage.message.length > 100 ? '...' : '');
                
                html += `
                    <div class="conversation-item">
                        <div class="conversation-header">
                            <div class="conversation-avatar">${avatarIcon}</div>
                            <div class="conversation-info">
                                <h4>${conv.user.name}</h4>
                                <div class="email">üìß ${conv.user.email}</div>
                            </div>
                        </div>
                        <div class="conversation-preview">"${preview}"</div>
                        <div class="conversation-time">${time}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function updateMessageBadge() {
            const badge = document.getElementById('message-badge');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Tabs
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            if (tabName === 'search') {
                renderSearch();
            } else if (tabName === 'messages') {
                loadMessages();
            }
        }
        
        // Init on load
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            init();
            
            // Check for new messages every 30 seconds
            setInterval(() => {
                if (currentUser) {
                    loadMessages();
                }
            }, 30000);
        });
    </script>
</body>
</html>
